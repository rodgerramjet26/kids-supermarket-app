<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Supermarket">
  <title>Kids Supermarket ‚Äî Play App</title>
  <!-- QR Code Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <style>
    :root{--bg:#f7fbff;--card:#ffffff;--accent:#2b9cff;--muted:#6b7280;--green:#22c55e}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI, Roboto, "Helvetica Neue", Arial; margin:0; background:linear-gradient(180deg,var(--bg),#eaf6ff); color:#0f172a}
    header{padding:16px 20px; display:flex; justify-content:space-between; align-items:center; gap:12px; border-bottom: 1px solid #eaf6ff;}
    h1{font-size:20px;margin:0}
    .header-title{display:flex; align-items:center; gap:12px;}
    nav {display:flex; gap:8px;}
    nav a {padding: 8px 12px; border-radius: 8px; text-decoration: none; color: var(--muted); font-weight: 500;}
    nav a.active {background: var(--accent); color: white;}
    .container{max-width:980px;margin:12px auto;padding:12px}
    .flex{display:flex;gap:12px}
    .products, .checkout{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 6px 18px rgba(11,38,63,0.06)}
    .products{flex:2}
    .checkout{flex:1;min-width:280px}
    .product-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px}
    .product{border-radius:10px;padding:8px;background:linear-gradient(180deg,#fff,#fbfdff);display:flex;flex-direction:column;align-items:center;gap:8px;border:1px solid #e6eef7}
    .product button{background:var(--accent);color:white;border:none;padding:6px 8px;border-radius:8px;cursor:pointer}
    .product .price{font-weight:700}
    .cart-list{max-height:320px;overflow:auto;margin-bottom:8px}
    .cart-item{display:flex;justify-content:space-between;gap:8px;padding:8px;border-radius:8px;background:#f8fbff;margin-bottom:6px;align-items:center}
    .qty{display:inline-flex;align-items:center;gap:6px}
    .qty button{padding:4px 8px;border-radius:6px;border:1px solid #d1e7ff;background:white;cursor:pointer}
    input[type=number], input[type=text]{width:100%;padding:8px;border-radius:8px;border:1px solid #d0d7de}
    .big{font-size:18px;font-weight:700}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .btn{padding:8px 10px;border-radius:8px;border:none;background:var(--accent);color:white;cursor:pointer;flex-grow:1;text-align:center}
    .btn.secondary{background:#6b7280}
    .btn.qr{background:var(--green)}
    .receipt{white-space:pre-wrap;background:#fff;padding:10px;border-radius:8px;border:1px dashed #dbeafe;max-height:260px;overflow:auto}
    footer{font-size:12px;color:var(--muted);text-align:center;margin-top:12px}
    
    /* Page Styles */
    .page { display: none; }
    .page.active { display: block; }

    /* QR Modal Styles */
    .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:1000}
    .modal-content{background:white;padding:24px;border-radius:16px;box-shadow:0 10px 25px rgba(0,0,0,0.1);text-align:center;width:90%;max-width:320px}
    .modal-content h2{margin-top:0;font-size:22px}
    #qrcode{display:flex;justify-content:center;align-items:center;margin:16px auto;padding:16px;background:white;border-radius:8px;border:1px solid #eee}
    #qrcode img{border-radius:4px}
    .modal-total{font-size:24px;font-weight:700;margin-bottom:16px}
    .modal-actions{display:flex;flex-direction:column;gap:10px}
    #payment-success{color:var(--green);font-weight:700;display:none;margin-bottom:10px}

    /* Scanner Page Styles */
    #scannerPage { text-align: center; }
    #videoContainer { position: relative; width: 100%; max-width: 500px; margin: 0 auto; border-radius: 12px; overflow: hidden; }
    #video { width: 100%; height: auto; display: block; }
    #scanBox { border: 3px solid rgba(255,255,255,0.7); position: absolute; top: 50%; left: 50%; width: 70%; height: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 0 4000px rgba(0,0,0,0.4); }
    #scanResult { margin-top: 20px; padding: 16px; background: var(--card); border-radius: 12px; }
    #scanResult .amount { font-size: 28px; font-weight: 700; color: var(--green); }
    #scanResult .message { color: var(--muted); }
    #scannerPayBtn { width: 100%; max-width: 300px; padding: 16px; font-size: 20px; margin-top: 16px; }


    @media (max-width:800px){.flex{flex-direction:column}.products{order:2}}
  </style>
</head>
<body>
  <header>
    <div class="header-title">
        <div style="font-size:28px">üõí</div>
        <h1>Kids Supermarket</h1>
    </div>
    <nav>
        <a href="#cashier" id="navCashier" class="nav-link active">Checkout</a>
        <a href="#scanner" id="navScanner" class="nav-link">Scanner</a>
    </nav>
  </header>

  <main class="container">
    <div id="cashierPage" class="page active">
        <div class="flex">
          <section class="products">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <strong>Products</strong>
              <div style="font-size:13px;color:var(--muted)">Tap "Add" to put into cart</div>
            </div>
            <div class="product-grid" id="productGrid"></div>
            <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
              <input id="customName" type="text" placeholder="Custom item name (e.g. Cookie)" />
              <input id="customPrice" type="number" placeholder="Price" min="0" step="0.01" />
              <button class="btn" id="addCustom">Add custom</button>
            </div>
          </section>
          <aside class="checkout">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <strong>Checkout</strong>
              <button class="btn secondary" id="clearCart">Clear</button>
            </div>
            <div class="cart-list" id="cartList">
              <div style="color:var(--muted);font-size:13px">Cart is empty</div>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
              <div>Total:</div>
              <div class="big" id="total">$0.00</div>
            </div>
            <label style="font-size:13px;color:var(--muted)">Enter amount paid:</label>
            <input type="number" id="paidAmt" placeholder="0.00" min="0" step="0.01" />
            <div style="margin-top:8px;" class="controls">
              <button class="btn" id="calcChange">Calculate Change</button>
              <button class="btn qr" id="qrPayBtn">Pay with QR</button>
              <button class="btn secondary" id="exactBtn">Exact Pay</button>
            </div>
            <div style="margin-top:12px">
              <div style="font-weight:700">Change:</div>
              <div id="changeDisplay" style="font-size:16px;color:#065f46;margin-top:6px">$0.00</div>
              <div id="coinBreakdown" style="margin-top:6px;color:var(--muted);font-size:13px"></div>
            </div>
            <div style="margin-top:12px">
              <div style="font-weight:700;margin-bottom:6px">Receipt</div>
              <div class="receipt" id="receipt">No receipt yet.</div>
              <div style="display:flex;gap:8px;margin-top:8px">
                <button class="btn" id="printBtn">Print / Save</button>
                <button class="btn secondary" id="newSale">New Sale</button>
              </div>
            </div>
          </aside>
        </div>
        <footer>Tip: use big round coins (emoji) for imaginative play ‚Äî try paying with coins like 1, 5, 10, 20!</footer>
    </div>

    <div id="scannerPage" class="page">
        <h2>QR Payment Scanner</h2>
        <p>Point your camera at a QR code from the checkout screen.</p>
        <div id="videoContainer">
            <video id="video" playsinline></video>
            <div id="scanBox"></div>
        </div>
        <canvas id="canvas" style="display:none;"></canvas>
        <div id="scanResult">
            <div id="scanMessage" class="message">Waiting for QR code...</div>
        </div>
    </div>
  </main>

  <!-- QR Payment Modal -->
  <div class="modal-overlay" id="qrModal">
    <div class="modal-content">
      <h2>Scan to Pay</h2>
      <p style="font-size:14px;color:var(--muted);margin:0">Show this QR to the cashier!</p>
      <div id="qrcode"></div>
      <div class="modal-total" id="modalTotal"></div>
      <div id="payment-success">Payment Successful! ‚úÖ</div>
      <div class="modal-actions">
        <button class="btn qr" id="confirmPaymentBtn">Confirm Payment</button>
        <button class="btn secondary" id="closeModalBtn">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    // --- Global State ---
    let cart = [];
    let qrcodeInstance = null;
    let videoStream = null;
    let animationFrameId = null;

    // --- Product catalogue (name, price, emoji) ---
    const products = [
      {id:1,name:'Apple',price:0.60,icon:'üçé'}, 
      {id:2,name:'Banana',price:0.40,icon:'üçå'},
      {id:3,name:'Potato',price:0.60,icon:'ü•î'},
      {id:4,name:'Bread',price:1.50,icon:'üçû'},
      {id:5,name:'Eggs (6)',price:2.10,icon:'ü•ö'}, 
      {id:6,name:'Cookie',price:0.80,icon:'üç™'},
      {id:7,name:'Meat',price:1.00,icon:'ü•©'},
      {id:8,name:'Vegetables',price:3.20,icon:'ü•¨'},
      {id:9,name:'Cheese',price:2.50,icon:'üßÄ'},
      {id:10,name:'Toy Car',price:4.00,icon:'üöó'},
      {id:11,name:'Sweets',price:2.00,icon:'üç´'}
    ];

    // --- DOM Elements ---
    const cashierPage = document.getElementById('cashierPage');
    const scannerPage = document.getElementById('scannerPage');
    const productGrid = document.getElementById('productGrid');
    const cartList = document.getElementById('cartList');
    const totalEl = document.getElementById('total');
    const paidAmt = document.getElementById('paidAmt');
    const changeDisplay = document.getElementById('changeDisplay');
    const coinBreakdown = document.getElementById('coinBreakdown');
    const receiptEl = document.getElementById('receipt');
    
    // --- QR Modal Elements ---
    const qrModal = document.getElementById('qrModal');
    const qrcodeContainer = document.getElementById('qrcode');
    const modalTotalEl = document.getElementById('modalTotal');
    const paymentSuccessEl = document.getElementById('payment-success');

    // --- Scanner Elements ---
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const canvasContext = canvas.getContext('2d');
    const scanResultEl = document.getElementById('scanResult');
    const scanMessageEl = document.getElementById('scanMessage');

    // --- Utility Functions ---
    function format(v){return '$' + v.toFixed(2)}

    // --- Page Navigation ---
    function switchPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        document.querySelector(`a[href="#${pageId.replace('Page','')}"]`).classList.add('active');

        if (pageId === 'scannerPage') {
            startScanner();
        } else {
            stopScanner();
        }
    }

    document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const pageId = e.target.getAttribute('href').substring(1) + 'Page';
            switchPage(pageId);
        });
    });

    // --- Cashier Page Logic ---
    function renderProducts(){
      productGrid.innerHTML = '';
      products.forEach(p=>{
        const el = document.createElement('div'); el.className='product';
        el.innerHTML = `<div style="font-size:28px">${p.icon}</div><div style="text-align:center"><div>${p.name}</div><div class="price">${format(p.price)}</div></div>`;
        const btn = document.createElement('button'); btn.textContent='Add';
        btn.addEventListener('click',()=>addToCart(p));
        el.appendChild(btn);
        productGrid.appendChild(el);
      });
    }

    function addToCart(product){
      const found = cart.find(c=>c.id===product.id);
      if(found){found.qty += 1;} else {cart.push({...product, qty:1});}
      renderCart();
    }

    function renderCart(){
      cartList.innerHTML = '';
      if(cart.length===0){cartList.innerHTML = '<div style="color:var(--muted);font-size:13px">Cart is empty</div>'; updateTotals(); return}
      cart.forEach(item=>{
        const div = document.createElement('div'); div.className='cart-item';
        div.innerHTML = `<div style="display:flex;gap:8px;align-items:center"><div style="font-size:20px">${item.icon}</div><div><div style="font-weight:700">${item.name}</div><div style="font-size:13px;color:var(--muted)">${format(item.price)} each</div></div></div>`;
        const right = document.createElement('div');
        right.innerHTML = `<div style="text-align:right"><div style="font-weight:700">${format(item.price*item.qty)}</div><div class="qty"><button data-action="dec">-</button><div style="min-width:22px;text-align:center">${item.qty}</div><button data-action="inc">+</button></div><button style="margin-top:6px; padding: 2px 4px; font-size:12px;" data-action="rem">Remove</button></div>`;
        right.querySelectorAll('button').forEach(b=>{
          b.addEventListener('click',()=>{
            const act = b.getAttribute('data-action');
            if(act==='inc'){item.qty +=1}
            if(act==='dec'){item.qty = Math.max(1,item.qty-1)}
            if(act==='rem'){cart = cart.filter(c=>c!==item)}
            renderCart();
          })
        })
        div.appendChild(right);
        cartList.appendChild(div);
      })
      updateTotals();
    }

    function updateTotals(){
      const total = cart.reduce((s,i)=>s + i.price * i.qty,0);
      totalEl.textContent = format(total);
      if(cart.length===0){receiptEl.textContent = 'No receipt yet.'; return}
      let lines = ['*** Kids Checkout Receipt ***', new Date().toLocaleString(), ''];
      cart.forEach(i=> lines.push(`${i.qty} x ${i.name} ${' '.repeat(6)} ${format(i.price*i.qty)}`));
      lines.push('--------------------------', `Total: ${format(total)}`);
      receiptEl.textContent = lines.join('\n');
    }

    function calculateChange(paymentMethod = 'Cash'){
      const total = cart.reduce((s,i)=>s + i.price * i.qty,0);
      const paid = parseFloat(paidAmt.value) || 0;
      const diff = +(paid - total).toFixed(2);
      if(diff < 0){changeDisplay.textContent = 'Not enough money ‚Äî needs ' + format(Math.abs(diff)); coinBreakdown.textContent=''; return}
      changeDisplay.textContent = format(diff);
      coinBreakdown.textContent = breakdownCoins(diff);
      let r = receiptEl.textContent + `\n\nPaid (${paymentMethod}): ${format(paid)}\nChange: ${format(diff)}`;
      receiptEl.textContent = r
    }

    function breakdownCoins(amount){
      let cents = Math.round(amount * 100);
      if(cents===0) return 'No change.';
      const coins = [10000,5000,2000,1000,500,100,50,25,10,5,1];
      const coinNames = {10000:'$100',5000:'$50',2000:'$20',1000:'$10',500:'$5',100:'$1',50:'50¬¢',25:'25¬¢',10:'10¬¢',5:'5¬¢',1:'1¬¢'};
      let parts = [];
      for(const c of coins){
        if(cents>=c){
          const q = Math.floor(cents/c);
          cents -= q*c;
          parts.push(`${q} x ${coinNames[c]}`)
        }
      }
      return parts.join(', ');
    }

    function resetCheckoutState() {
        paidAmt.value='';
        changeDisplay.textContent='$0.00';
        coinBreakdown.textContent='';
        qrModal.style.display = 'none';
    }

    function startNewSale() {
        cart=[];
        renderCart();
        resetCheckoutState();
        receiptEl.textContent='No receipt yet.';
    }

    // --- Event Listeners (Cashier Page) ---
    document.getElementById('calcChange').addEventListener('click', () => calculateChange('Cash'));
    document.getElementById('exactBtn').addEventListener('click',()=>{
      const total = cart.reduce((s,i)=>s + i.price * i.qty,0);
      paidAmt.value = total.toFixed(2);
      calculateChange('Exact Cash');
    });
    document.getElementById('clearCart').addEventListener('click',()=> { cart=[]; renderCart(); resetCheckoutState(); });
    document.getElementById('newSale').addEventListener('click', startNewSale);
    document.getElementById('addCustom').addEventListener('click',()=>{
      const name = document.getElementById('customName').value.trim();
      const price = parseFloat(document.getElementById('customPrice').value);
      if(!name || isNaN(price) || price<0){alert('Please enter a name and valid price for the custom item.'); return}
      products.push({id:Date.now(),name,price,icon:'üç≠'});
      document.getElementById('customName').value=''; document.getElementById('customPrice').value='';
      renderProducts();
    });
    document.getElementById('printBtn').addEventListener('click',()=>{
      const w = window.open('', '_blank');
      const html = `<!doctype html><html><head><title>Receipt</title></head><body><pre style="font-family:monospace; font-size:14px;">${receiptEl.textContent}</pre></body></html>`;
      w.document.write(html); w.document.close(); w.print();
    });

    // --- QR Modal Logic ---
    document.getElementById('qrPayBtn').addEventListener('click', () => {
        const total = cart.reduce((s,i)=>s + i.price * i.qty,0);
        if (total <= 0) { alert("Please add items to the cart first!"); return; }
        paymentSuccessEl.style.display = 'none';
        document.getElementById('confirmPaymentBtn').style.display = 'block';
        modalTotalEl.textContent = format(total);
        qrModal.style.display = 'flex';
        qrcodeContainer.innerHTML = '';
        const qrPayload = `PROMPTPAY-KIDS\nAMOUNT:${total.toFixed(2)}`;
        new QRCode(qrcodeContainer, { text: qrPayload, width: 200, height: 200, correctLevel : QRCode.CorrectLevel.H });
    });
    document.getElementById('closeModalBtn').addEventListener('click', () => { qrModal.style.display = 'none'; });
    document.getElementById('confirmPaymentBtn').addEventListener('click', () => {
        const total = cart.reduce((s,i)=>s + i.price * i.qty,0);
        paidAmt.value = total.toFixed(2);
        paymentSuccessEl.style.display = 'block';
        document.getElementById('confirmPaymentBtn').style.display = 'none';
        setTimeout(() => { calculateChange('QR Payment'); qrModal.style.display = 'none'; }, 1500);
    });

    // --- Scanner Page Logic ---
    async function startScanner() {
        try {
            videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            video.srcObject = videoStream;
            video.setAttribute("playsinline", true); // Required to work on iOS
            video.play();
            scanMessageEl.innerHTML = 'Waiting for QR code...';
            scanResultEl.innerHTML = '';
            scanResultEl.appendChild(scanMessageEl);
            animationFrameId = requestAnimationFrame(tick);
        } catch (err) {
            console.error("Camera Error:", err);
            scanMessageEl.textContent = "Could not access camera. Please grant permission.";
        }
    }

    function stopScanner() {
        if (videoStream) {
            videoStream.getTracks().forEach(track => track.stop());
            videoStream = null;
        }
        if (animationFrameId) {
            cancelAnimationFrame(animationFrameId);
            animationFrameId = null;
        }
    }

    function tick() {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            canvas.height = video.videoHeight;
            canvas.width = video.videoWidth;
            canvasContext.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = canvasContext.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });

            if (code && code.data.startsWith('PROMPTPAY-KIDS')) {
                stopScanner();
                handleScannedCode(code.data);
                return; // Stop the loop
            }
        }
        animationFrameId = requestAnimationFrame(tick);
    }

    function handleScannedCode(data) {
        const parts = data.split('\n');
        const amountLine = parts.find(p => p.startsWith('AMOUNT:'));
        if (!amountLine) {
            scanMessageEl.textContent = "Invalid QR Code. Try again.";
            setTimeout(startScanner, 2000); // Try again after 2s
            return;
        }
        const amount = parseFloat(amountLine.split(':')[1]);
        
        scanResultEl.innerHTML = `
            <div class="message">Payment Request Found!</div>
            <div class="amount">${format(amount)}</div>
            <button class="btn qr" id="scannerPayBtn">Pay Now</button>
        `;

        document.getElementById('scannerPayBtn').addEventListener('click', () => {
            scanResultEl.innerHTML = `
                <div class="amount" style="color:var(--green)">Paid ${format(amount)}!</div>
                <div class="message">Success! ‚úÖ Returning to checkout...</div>
            `;
            setTimeout(() => {
                switchPage('cashierPage');
            }, 5000);
        });
    }

    // --- Initial Load ---
    renderProducts();
    renderCart();
    switchPage('cashierPage'); // Start on the cashier page
  </script>
</body>
</html>
